<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock News - ë¯¸êµ­ ì£¼ì‹ ë‰´ìŠ¤</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ“Š</text></svg>">
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif; }
    #root { width: 100vw; height: 100vh; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .tier-divider { animation: fadeIn 0.5s ease-out; }
    .settings-scroll::-webkit-scrollbar { width: 6px; }
    .settings-scroll::-webkit-scrollbar-track { background: transparent; }
    .settings-scroll::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 3px; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }
    .slide-up { animation: slideUp 0.2s ease-out; }
  </style>
</head>
<body>
  <div id="root">
    <div style="display:flex;align-items:center;justify-content:center;height:100vh;background:#000;">
      <div style="text-align:center;color:white;">
        <div style="font-size:48px;margin-bottom:20px;">ğŸ“Š</div>
        <div style="font-size:20px;">ë¡œë”© ì¤‘...</div>
      </div>
    </div>
  </div>
  <script>
    const { useState, useEffect, useRef, useCallback } = React;
    const e = React.createElement;

    // API base URL: ìƒëŒ€ ê²½ë¡œ (ê°™ì€ ì„œë²„)
    const API = '';

    function loadSaved(key, def) { try { const s = localStorage.getItem(key); if (s !== null) return JSON.parse(s); } catch(e){} return def; }
    function save(key, val) { try { localStorage.setItem(key, JSON.stringify(val)); } catch(e){} }

    function StockNewsApp() {
      const [currentIndex, setCurrentIndex] = useState(0);
      const [news, setNews] = useState([]);
      const [loading, setLoading] = useState(false);
      const [showSettings, setShowSettings] = useState(false);
      const [tickers, setTickers] = useState(() => loadSaved('stocknews_tickers', ['TSLA','AAPL','NVDA','MSFT']));
      const [newTicker, setNewTicker] = useState('');
      const [language, setLanguage] = useState(() => loadSaved('stocknews_language', 'ko'));
      const [error, setError] = useState(null);
      const [tickerError, setTickerError] = useState(null);
      const [suggestions, setSuggestions] = useState([]);
      const [validating, setValidating] = useState(false);
      const touchStartY = useRef(0);
      const lastScrollTime = useRef(0);

      useEffect(() => { save('stocknews_tickers', tickers); }, [tickers]);
      useEffect(() => { save('stocknews_language', language); }, [language]);

      const t = {
        ko: {
          loadingNews: 'ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...',
          errorTitle: 'ë‰´ìŠ¤ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤',
          errorContent: 'ì„œë²„ ì—°ê²°ì„ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.',
          refreshNews: 'ë‰´ìŠ¤ ìƒˆë¡œê³ ì¹¨',
          tickerManagement: 'ì„¤ì •',
          addNewTicker: 'ìƒˆ í‹°ì»¤ ì¶”ê°€',
          currentTickers: 'í˜„ì¬ ì¶”ì  ì¤‘ì¸ í‹°ì»¤',
          language: 'ì–¸ì–´', korean: 'í•œêµ­ì–´', english: 'English',
          positive: 'â†‘ ê¸ì •', negative: 'â†“ ë¶€ì •', neutral: 'âˆ¼ ì¤‘ë¦½',
          invalidTicker: 'ìœ íš¨í•˜ì§€ ì•Šì€ í‹°ì»¤ì…ë‹ˆë‹¤',
          didYouMean: 'í˜¹ì‹œ ì´ í‹°ì»¤ë¥¼ ì°¾ìœ¼ì…¨ë‚˜ìš”?',
          duplicateTicker: 'ì´ë¯¸ ì¶”ê°€ëœ í‹°ì»¤ì…ë‹ˆë‹¤',
          autoSaved: 'âœ… ì„¤ì •ì€ ìë™ ì €ì¥ë©ë‹ˆë‹¤'
        },
        en: {
          loadingNews: 'Loading news...',
          errorTitle: 'Failed to Load News',
          errorContent: 'Please check the connection and try again.',
          refreshNews: 'Refresh News',
          tickerManagement: 'Settings',
          addNewTicker: 'Add New Ticker',
          currentTickers: 'Tracking Tickers',
          language: 'Language', korean: 'í•œêµ­ì–´', english: 'English',
          positive: 'â†‘ Positive', negative: 'â†“ Negative', neutral: 'âˆ¼ Neutral',
          invalidTicker: 'Invalid ticker symbol',
          didYouMean: 'Did you mean one of these?',
          duplicateTicker: 'Ticker already added',
          autoSaved: 'âœ… Settings are auto-saved'
        }
      };

      useEffect(() => { fetchNews(); }, []);

      const fetchNews = async () => {
        setLoading(true); setError(null);
        try {
          const res = await fetch(API + "/api/news", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ tickers, language })
          });
          if (!res.ok) throw new Error('Server error');
          const data = await res.json();
          if (data.success && data.news && data.news.length > 0) {
            setNews(data.news); setCurrentIndex(0); setError(null);
          } else throw new Error(data.error || 'No news');
        } catch (err) { setError(err.message); setNews([]); }
        finally { setLoading(false); }
      };

      const validateAndAdd = async (tickerStr) => {
        const ticker = (tickerStr || newTicker).trim().toUpperCase();
        if (!ticker) return;
        if (tickers.includes(ticker)) { setTickerError(t[language].duplicateTicker); setSuggestions([]); return; }
        setValidating(true); setTickerError(null); setSuggestions([]);
        try {
          const res = await fetch(API + "/api/validate-ticker", {
            method: "POST", headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ ticker })
          });
          const data = await res.json();
          if (data.valid) { setTickers([...tickers, data.ticker]); setNewTicker(''); setTickerError(null); setSuggestions([]); }
          else { setTickerError(t[language].invalidTicker); if (data.suggestions?.length > 0) setSuggestions(data.suggestions); }
        } catch (err) { setTickers([...tickers, ticker]); setNewTicker(''); setTickerError(null); setSuggestions([]); }
        finally { setValidating(false); }
      };

      const addSuggestion = (ticker) => {
        if (!tickers.includes(ticker)) setTickers([...tickers, ticker]);
        setNewTicker(''); setTickerError(null); setSuggestions([]);
      };

      const removeTicker = (ticker) => { if (tickers.length > 1) setTickers(tickers.filter(t => t !== ticker)); };

      const handleScroll = useCallback((dir) => {
        const now = Date.now();
        if (now - lastScrollTime.current < 250) return;
        lastScrollTime.current = now;
        if (dir === 'down' && currentIndex < news.length - 1) setCurrentIndex(p => p + 1);
        else if (dir === 'up' && currentIndex > 0) setCurrentIndex(p => p - 1);
      }, [currentIndex, news.length]);

      useEffect(() => {
        const h = (ev) => { if (showSettings) return; ev.preventDefault(); handleScroll(ev.deltaY > 0 ? 'down' : 'up'); };
        window.addEventListener('wheel', h, { passive: false }); return () => window.removeEventListener('wheel', h);
      }, [handleScroll, showSettings]);

      useEffect(() => {
        let sy = 0;
        const ts = (ev) => { sy = ev.touches[0].clientY; };
        const te = (ev) => { if (showSettings) return; const d = sy - ev.changedTouches[0].clientY; if (Math.abs(d) > 50) handleScroll(d > 0 ? 'down' : 'up'); };
        window.addEventListener('touchstart', ts); window.addEventListener('touchend', te);
        return () => { window.removeEventListener('touchstart', ts); window.removeEventListener('touchend', te); };
      }, [handleScroll, showSettings]);

      useEffect(() => {
        const h = (ev) => {
          if (showSettings) return;
          if (ev.key === 'ArrowDown' || ev.key === ' ') { ev.preventDefault(); handleScroll('down'); }
          else if (ev.key === 'ArrowUp') { ev.preventDefault(); handleScroll('up'); }
        };
        window.addEventListener('keydown', h); return () => window.removeEventListener('keydown', h);
      }, [handleScroll, showSettings]);

      const getTickerColor = (ticker) => {
        const specials = ['U.S. News','ë¯¸êµ­ ì‹œì¥','U.S. Market','ë¯¸êµ­ ì •ì¹˜','US Politics','ê¸ˆë¦¬Â·ì—°ì¤€','Fed & Rates','ë¯¸ì¤‘ ê²½ìŸ','US-China','ì§€ì •í•™','Geopolitics','ì•”í˜¸í™”í','Crypto','í…Œí¬ íŠ¸ë Œë“œ','Tech Trends','ì›ìì¬','Commodities','ì‹¤ì  ì‹œì¦Œ','Earnings'];
        if (specials.includes(ticker)) return 'bg-gray-600';
        const colors = ['bg-purple-600','bg-pink-600','bg-indigo-600','bg-cyan-600','bg-amber-600','bg-emerald-600','bg-rose-600','bg-teal-600','bg-violet-600','bg-lime-600'];
        const idx = tickers.indexOf(ticker);
        return idx >= 0 ? colors[idx % colors.length] : 'bg-sky-600';
      };

      const getTierBg = (item) => {
        const map = { core_positive:'linear-gradient(135deg,#1e3a8a,#1e40af)', core_negative:'linear-gradient(135deg,#7f1d1d,#991b1b)', core_neutral:'linear-gradient(135deg,#1f2937,#374151)', related_positive:'linear-gradient(135deg,#14532d,#166534)', related_neutral:'linear-gradient(135deg,#1e293b,#334155)', market:'linear-gradient(135deg,#1e1b4b,#312e81)', fed:'linear-gradient(135deg,#1c1917,#292524)', politics:'linear-gradient(135deg,#172554,#1e3a5f)', uschina:'linear-gradient(135deg,#3b0764,#581c87)', geopolitics:'linear-gradient(135deg,#0c4a6e,#075985)', crypto:'linear-gradient(135deg,#431407,#7c2d12)', techtrends:'linear-gradient(135deg,#064e3b,#065f46)', commodities:'linear-gradient(135deg,#78350f,#92400e)', earnings:'linear-gradient(135deg,#1e1b4b,#2e1065)', trending:'linear-gradient(135deg,#7f1d1d,#9a3412)' };
        if (item.tier === 'core') return map[`core_${item.impact}`] || map.core_neutral;
        if (item.tier === 'related') return map[`related_${item.impact === 'positive' ? 'positive' : 'neutral'}`];
        return map[item.tier] || map.core_neutral;
      };

      const getImpactColor = (i) => i==='positive'?'text-green-400':i==='negative'?'text-red-400':'text-gray-400';
      const isNewTier = (i) => i === 0 || news[i].tier !== news[i-1].tier;

      if (loading) return e('div',{className:'h-screen w-screen flex items-center justify-center bg-black'},e('div',{className:'text-center'},e('div',{className:'text-6xl mb-4'},'ğŸ“Š'),e('p',{className:'text-white text-xl'},t[language].loadingNews)));

      if (error) return e('div',{className:'h-screen w-screen flex items-center justify-center bg-black p-6'},e('div',{className:'text-center max-w-md'},e('div',{className:'bg-red-600 bg-opacity-20 border-2 border-red-600 rounded-2xl p-8'},e('div',{className:'text-6xl text-red-500 mb-4'},'âš ï¸'),e('h2',{className:'text-white text-2xl font-bold mb-4'},t[language].errorTitle),e('p',{className:'text-gray-300 text-lg mb-6'},t[language].errorContent),e('div',{className:'flex gap-3 justify-center'},e('button',{onClick:fetchNews,className:'bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 font-medium'},t[language].refreshNews),e('button',{onClick:()=>setShowSettings(true),className:'bg-gray-700 text-white px-6 py-3 rounded-lg hover:bg-gray-600'},'âš™ï¸')))));

      return e('div',{className:'relative h-screen w-screen overflow-hidden bg-black'},
        // SETTINGS
        showSettings && e('div',{className:'absolute inset-0 bg-black bg-opacity-90 z-50 flex items-center justify-center p-4',onClick:(ev)=>{if(ev.target===ev.currentTarget){setShowSettings(false);setTickerError(null);setSuggestions([]);}}},
          e('div',{className:'bg-gray-900 rounded-2xl w-full max-w-md flex flex-col',style:{maxHeight:'85vh'}},
            e('div',{className:'flex items-center justify-between p-6 pb-4 border-b border-gray-800 flex-shrink-0'},
              e('h2',{className:'text-2xl font-bold text-white'},t[language].tickerManagement),
              e('button',{onClick:()=>{setShowSettings(false);setTickerError(null);setSuggestions([]);},className:'text-gray-400 hover:text-white text-2xl'},'âœ•')
            ),
            e('div',{className:'flex-1 overflow-y-auto settings-scroll p-6 pt-4'},
              e('div',{className:'mb-6'},
                e('label',{className:'text-gray-300 text-sm mb-2 block'},t[language].language),
                e('div',{className:'flex gap-2'},
                  e('button',{onClick:()=>setLanguage('ko'),className:`flex-1 py-3 rounded-lg font-medium transition-colors ${language==='ko'?'bg-blue-600 text-white':'bg-gray-800 text-gray-300 hover:bg-gray-700'}`},t[language].korean),
                  e('button',{onClick:()=>setLanguage('en'),className:`flex-1 py-3 rounded-lg font-medium transition-colors ${language==='en'?'bg-blue-600 text-white':'bg-gray-800 text-gray-300 hover:bg-gray-700'}`},t[language].english)
                )
              ),
              e('div',{className:'mb-4'},
                e('label',{className:'text-gray-300 text-sm mb-2 block'},t[language].addNewTicker),
                e('div',{className:'flex gap-2'},
                  e('input',{type:'text',value:newTicker,onChange:(ev)=>{setNewTicker(ev.target.value.toUpperCase());setTickerError(null);setSuggestions([]);},onKeyPress:(ev)=>ev.key==='Enter'&&validateAndAdd(),placeholder:'e.g., GOOGL',maxLength:5,className:`flex-1 bg-gray-800 text-white px-4 py-3 rounded-lg focus:outline-none focus:ring-2 ${tickerError?'focus:ring-red-500 ring-2 ring-red-500':'focus:ring-blue-500'}`}),
                  e('button',{onClick:()=>validateAndAdd(),disabled:validating,className:'bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 text-xl disabled:opacity-50'},validating?'...':'â•')
                ),
                tickerError && e('div',{className:'mt-2 slide-up'},
                  e('p',{className:'text-red-400 text-sm'},`âŒ ${tickerError}`),
                  suggestions.length>0 && e('div',{className:'mt-2'},
                    e('p',{className:'text-gray-400 text-xs mb-2'},t[language].didYouMean),
                    e('div',{className:'flex flex-wrap gap-2'},suggestions.map(s=>e('button',{key:s,onClick:()=>addSuggestion(s),className:'bg-blue-600 bg-opacity-30 text-blue-400 px-3 py-1.5 rounded-lg text-sm hover:bg-opacity-50 border border-blue-600 border-opacity-50'},s)))
                  )
                )
              ),
              e('div',{className:'mb-4'},
                e('label',{className:'text-gray-300 text-sm mb-3 block'},`${t[language].currentTickers} (${tickers.length})`),
                e('div',{className:'space-y-2'},tickers.map(ticker=>e('div',{key:ticker,className:'flex items-center justify-between bg-gray-800 px-4 py-3 rounded-lg'},e('div',{className:'flex items-center gap-3'},e('span',{className:`w-3 h-3 rounded-full ${getTickerColor(ticker)}`}),e('span',{className:'text-white font-medium'},ticker)),tickers.length>1&&e('button',{onClick:()=>removeTicker(ticker),className:'text-red-400 hover:text-red-300 text-lg'},'âœ•'))))
              ),
              e('div',{className:'text-center py-2'},e('span',{className:'text-gray-500 text-xs'},t[language].autoSaved))
            ),
            e('div',{className:'p-6 pt-4 border-t border-gray-800 flex-shrink-0'},
              e('button',{onClick:()=>{fetchNews();setShowSettings(false);setTickerError(null);setSuggestions([]);},className:'w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-medium text-lg'},t[language].refreshNews)
            )
          )
        ),
        // CONTENT
        e('div',{className:'h-full w-full',style:{transform:`translateY(-${currentIndex*100}vh)`,transition:'transform 0.4s ease-out'}},
          news.map((item,index)=>e('div',{key:index,className:'h-screen w-full flex items-center justify-center p-6',style:{background:getTierBg(item)}},
            e('div',{className:'max-w-2xl w-full'},
              isNewTier(index)&&e('div',{className:'tier-divider mb-4'},e('span',{className:'text-gray-300 text-sm font-medium px-3 py-1 rounded-full bg-white bg-opacity-10'},item.tierLabel)),
              e('div',{className:'flex items-center gap-3 mb-5'},
                e('span',{className:`${getTickerColor(item.ticker)} text-white px-4 py-1.5 rounded-full font-bold text-sm`},item.ticker),
                e('span',{className:'text-gray-400 text-sm'},item.time),
                !isNewTier(index)&&e('span',{className:'text-gray-500 text-xs ml-auto hidden sm:inline'},item.tierLabel)
              ),
              e('h1',{className:'text-white text-3xl md:text-4xl font-bold mb-5 leading-tight'},item.title),
              e('p',{className:'text-gray-200 text-lg md:text-xl leading-relaxed mb-5'},item.content),
              e('div',{className:'flex items-center justify-between pt-4 border-t border-gray-600 border-opacity-40'},
                e('span',{className:'text-gray-400 text-sm'},item.source),
                e('span',{className:`font-medium text-sm ${getImpactColor(item.impact)}`},item.impact==='positive'?t[language].positive:item.impact==='negative'?t[language].negative:t[language].neutral)
              ),
              e('div',{className:'flex justify-center mt-5'},e('span',{className:'text-gray-500 text-sm'},`${currentIndex+1} / ${news.length}`))
            )
          ))
        ),
        // TOP BAR
        e('div',{className:'absolute top-4 right-4 flex items-center gap-3 z-40'},
          e('span',{className:'text-gray-300 text-sm bg-black bg-opacity-60 px-3 py-1.5 rounded-full backdrop-blur'},`${currentIndex+1}/${news.length}`),
          e('button',{onClick:()=>{setShowSettings(true);setTickerError(null);setSuggestions([]);},className:'bg-gray-800 bg-opacity-80 text-white w-10 h-10 rounded-full hover:bg-opacity-100 flex items-center justify-center text-lg'},'âš™ï¸')
        ),
        currentIndex>0&&e('button',{onClick:()=>handleScroll('up'),className:'absolute top-16 left-1/2 transform -translate-x-1/2 text-white text-2xl opacity-20 hover:opacity-70 z-40'},'â–²'),
        currentIndex<news.length-1&&e('button',{onClick:()=>handleScroll('down'),className:'absolute bottom-6 left-1/2 transform -translate-x-1/2 text-white text-2xl opacity-20 hover:opacity-70 z-40'},'â–¼')
      );
    }

    window.addEventListener('load',()=>{
      if(typeof React!=='undefined'&&typeof ReactDOM!=='undefined') ReactDOM.createRoot(document.getElementById('root')).render(e(StockNewsApp));
      else document.getElementById('root').innerHTML='<div style="color:white;text-align:center;padding-top:40vh;">React failed to load.</div>';
    });
  </script>
</body>
</html>
